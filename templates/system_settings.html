{% extends "base.html" %}

{% block title %}System Settings - KTU Admin{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Settings Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="dashboard-title">
                    <i class="fas fa-cogs me-3"></i>System Settings
                </h1>
                <p class="dashboard-subtitle text-muted">Configure system-wide settings and preferences</p>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <form method="POST" action="#">
        <div class="row g-4">
            {% for category, settings in settings_by_category.items() %}
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            {% if category == 'general' %}
                                <i class="fas fa-info-circle me-2"></i>General Settings
                            {% elif category == 'appearance' %}
                                <i class="fas fa-palette me-2"></i>Appearance
                            {% elif category == 'notifications' %}
                                <i class="fas fa-bell me-2"></i>Notifications
                            {% elif category == 'workflow' %}
                                <i class="fas fa-tasks me-2"></i>Workflow
                            {% elif category == 'files' %}
                                <i class="fas fa-file me-2"></i>File Management
                            {% elif category == 'system' %}
                                <i class="fas fa-server me-2"></i>System
                            {% else %}
                                <i class="fas fa-cog me-2"></i>{{ category.title() }}
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for setting in settings %}
                        <div class="mb-3">
                            <label for="setting_{{ setting.key }}" class="form-label">
                                <strong>{{ setting.key.replace('_', ' ').title() }}</strong>
                                {% if setting.description %}
                                    <small class="text-muted d-block">{{ setting.description }}</small>
                                {% endif %}
                            </label>
                            
                            {% if setting.key in ['email_notifications', 'auto_assign_issues', 'maintenance_mode', 'registration_enabled'] %}
                                <!-- Boolean settings -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           id="setting_{{ setting.key }}" 
                                           name="setting_{{ setting.key }}" 
                                           value="true"
                                           {% if setting.value.lower() == 'true' %}checked{% endif %}>
                                    <label class="form-check-label" for="setting_{{ setting.key }}">
                                        Enable {{ setting.key.replace('_', ' ').title() }}
                                    </label>
                                </div>
                                <input type="hidden" name="setting_{{ setting.key }}" value="false">
                            
                            {% elif setting.key == 'theme_color' %}
                                <!-- Color picker -->
                                <div class="input-group">
                                    <input type="color" class="form-control form-control-color" 
                                           id="setting_{{ setting.key }}" 
                                           name="setting_{{ setting.key }}" 
                                           value="{{ setting.value }}">
                                    <input type="text" class="form-control" 
                                           value="{{ setting.value }}" 
                                           readonly>
                                </div>
                            
                            {% elif setting.key in ['issue_categories', 'priority_levels', 'allowed_file_types'] %}
                                <!-- Comma-separated values -->
                                <textarea class="form-control" 
                                          id="setting_{{ setting.key }}" 
                                          name="setting_{{ setting.key }}" 
                                          rows="3" 
                                          placeholder="Enter values separated by commas">{{ setting.value }}</textarea>
                                <small class="form-text text-muted">Separate multiple values with commas</small>
                            
                            {% elif setting.key == 'max_file_size' %}
                                <!-- Number input with unit -->
                                <div class="input-group">
                                    <input type="number" class="form-control" 
                                           id="setting_{{ setting.key }}" 
                                           name="setting_{{ setting.key }}" 
                                           value="{{ setting.value }}" 
                                           min="1" max="100">
                                    <span class="input-group-text">MB</span>
                                </div>
                            
                            {% else %}
                                <!-- Regular text input -->
                                <input type="text" class="form-control" 
                                       id="setting_{{ setting.key }}" 
                                       name="setting_{{ setting.key }}" 
                                       value="{{ setting.value }}">
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Save Button -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>Save All Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg ms-3" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>Reset Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Advanced Settings -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Advanced Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-danger w-100" onclick="clearCache()">
                                <i class="fas fa-trash me-2"></i>Clear System Cache
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-warning w-100" onclick="resetDatabase()">
                                <i class="fas fa-database me-2"></i>Reset Statistics
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-info w-100" onclick="exportSettings()">
                                <i class="fas fa-download me-2"></i>Export Settings
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Warning:</strong> Advanced settings can affect system performance and functionality. 
                        Use with caution and ensure you have proper backups.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info me-2"></i>System Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>System Version:</strong> KTU Student Report System v2.0</p>
                            <p><strong>Last Updated:</strong> <span id="currentTime"></span></p>
                            <p><strong>Database Status:</strong> <span class="badge bg-success">Connected</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email Service:</strong> <span class="badge bg-success">GMass SMTP Active</span></p>
                            <p><strong>Storage Used:</strong> <span id="storageUsed">Calculating...</span></p>
                            <p><strong>Active Sessions:</strong> <span id="activeSessions">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
// Form validation and interaction
document.addEventListener('DOMContentLoaded', function() {
    // Color picker sync
    const colorInput = document.querySelector('input[type="color"]');
    const colorText = colorInput?.nextElementSibling;
    
    if (colorInput && colorText) {
        colorInput.addEventListener('input', function() {
            colorText.value = this.value;
        });
    }
    
    // Auto-save indication
    const form = document.querySelector('form');
    let hasChanges = false;
    
    form.addEventListener('input', function() {
        hasChanges = true;
        updateSaveButton();
    });
    
    function updateSaveButton() {
        const saveBtn = document.querySelector('button[type="submit"]');
        if (hasChanges) {
            saveBtn.classList.add('btn-warning');
            saveBtn.classList.remove('btn-primary');
            saveBtn.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Save Changes';
        }
    }
    
    // Load system info
    loadSystemInfo();
});

function resetForm() {
    if (confirm('Are you sure you want to reset all changes?')) {
        location.reload();
    }
}

function clearCache() {
    showConfirmModal('Clear System Cache', 'This will clear all cached data. The system may be slower temporarily while cache rebuilds.', function() {
        // Simulate cache clearing
        showToast('System cache cleared successfully', 'success');
    });
}

function resetDatabase() {
    showConfirmModal('Reset Statistics', 'This will reset all statistical data but keep user accounts and issues. This action cannot be undone.', function() {
        // Simulate database reset
        showToast('Statistics reset successfully', 'warning');
    });
}

function exportSettings() {
    // Create and download settings file
    const settings = {};
    document.querySelectorAll('[name^="setting_"]').forEach(input => {
        const key = input.name.replace('setting_', '');
        settings[key] = input.type === 'checkbox' ? input.checked : input.value;
    });
    
    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'ktu_system_settings_' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
    
    URL.revokeObjectURL(url);
    showToast('Settings exported successfully', 'info');
}

function showConfirmModal(title, message, callback) {
    document.getElementById('confirmModal').querySelector('.modal-title').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    
    const confirmBtn = document.getElementById('confirmButton');
    confirmBtn.onclick = function() {
        callback();
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
    };
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function showToast(message, type = 'info') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

function loadSystemInfo() {
    // Simulate loading system information
    setTimeout(() => {
        document.getElementById('storageUsed').textContent = '2.3 GB / 10 GB';
        document.getElementById('activeSessions').textContent = '5 active';
    }, 1000);
}

// Form submission with loading state
document.querySelector('form').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
});
</script>

<style>
.dashboard-container {
    padding: 2rem;
}

.dashboard-title {
    color: #1e3a8a;
    font-weight: bold;
    margin: 0;
}

.form-control-color {
    width: 60px;
    height: 38px;
    padding: 0.375rem 0.5rem;
}

.card {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: none;
    border-radius: 10px;
}

.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
    border-radius: 10px 10px 0 0 !important;
}

.form-check-input:checked {
    background-color: #1e3a8a;
    border-color: #1e3a8a;
}

.btn-primary {
    background-color: #1e3a8a;
    border-color: #1e3a8a;
}

.btn-primary:hover {
    background-color: #1e40af;
    border-color: #1e40af;
}

.alert-warning {
    border-left: 4px solid #f59e0b;
}

.position-fixed {
    position: fixed !important;
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .header-actions {
        margin-top: 1rem;
    }
}
</style>

<script>
// Set current time
document.addEventListener('DOMContentLoaded', function() {
    const currentTimeElement = document.getElementById('currentTime');
    if (currentTimeElement) {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true
        };
        currentTimeElement.textContent = now.toLocaleDateString('en-US', options);
    }
    
    // Simulate storage calculation
    const storageElement = document.getElementById('storageUsed');
    if (storageElement) {
        setTimeout(() => {
            storageElement.innerHTML = '<span class="badge bg-info">2.3 MB</span>';
        }, 1000);
    }
    
    // Simulate active sessions
    const sessionsElement = document.getElementById('activeSessions');
    if (sessionsElement) {
        setTimeout(() => {
            sessionsElement.innerHTML = '<span class="badge bg-primary">3 Active</span>';
        }, 1500);
    }
});
</script>

{% endblock %}
